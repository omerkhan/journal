---
import FeedItem from './FeedItem.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  posts: CollectionEntry<'posts'>[];
}

const { posts } = Astro.props;
const getSlug = (id: string) => id.replace(/\.md$/, '');

// Get image URL from any of the possible field formats
const getImageUrl = (data: CollectionEntry<'posts'>['data']): string | null => {
  if (data.photo) return data.photo;
  if (data.image) return data.image;
  if (data.media?.url) return data.media.url;
  return null;
};

// Helper to extract excerpt from post body
const getExcerpt = (body: string, maxLength: number = 200): string => {
  // Remove markdown formatting
  const plainText = body
    .replace(/#{1,6}\s/g, '')  // headers
    .replace(/\*\*|__/g, '')   // bold
    .replace(/\*|_/g, '')      // italic
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')  // links
    .replace(/`{1,3}[^`]*`{1,3}/g, '')  // code
    .replace(/\n+/g, ' ')      // newlines
    .trim();

  if (plainText.length <= maxLength) return plainText;
  return plainText.slice(0, maxLength).trim() + '...';
};
---

<div class="space-y-12">
  {posts.map((post) => (
    <FeedItem
      title={post.data.title}
      date={post.data.date}
      slug={getSlug(post.id)}
      image={getImageUrl(post.data)}
      location={post.data.location}
      excerpt={getExcerpt(post.body || '')}
    />
  ))}
</div>
